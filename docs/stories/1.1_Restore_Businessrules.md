## Task: Restore Business Logic to Optimized Duplicate Checker

### 1. Current Work Summary

The duplicate detection system was optimized for performance (7.5M records) but lost critical business logic in the process. The original system was designed for **fraud detection** in webshop rating services, where fraudsters deliberately modify names to evade detection.

### 2. Key Technical Concepts

**Two-Stage Architecture:**
- **Stage 1:** Exact matching with normalized strings (high confidence 90-100%)
- **Stage 2:** Fuzzy matching for remaining candidates (medium confidence 60-95%)
- These stages were collapsed into a single fuzzy matching pass

**Four-Combination Matrix:**
Should test and score all combinations:
1. Exact match, normal order (90-100% confidence)
2. Exact match, swapped order (85-95% confidence)
3. Fuzzy match, normal order (70-90% confidence)
4. Fuzzy match, swapped order (65-85% confidence)

**Performance Optimizations to Keep:**
- PLZ-based blocking (reduces comparison space)
- Vectorized operations for normalization
- Parallel processing with ProcessPoolExecutor
- Early termination strategies

### 3. Relevant Files and Code

**File: `duplicate_checker_optimized.py`**
- Current optimized implementation
- Has correct date rules implementation (verified working)
- Missing: Two-stage architecture, proper confidence scoring, exact match detection
- Key class: `UltraFastDuplicateChecker` with `analyze_duplicates` method
- Worker function: `process_block_worker` (needs refactoring for two stages)

**File: `duplicate_checker_poc.py`**
- Original POC with correct business logic
- Shows proper two-stage implementation
- Has correct confidence scoring formulas:
  ```python
  # Exact: 85-100%
  confidence = 85 + (exact_ratio * 15)
  
  # Fuzzy: capped at 95%
  base = name_score * 50
  address_bonus = addr_ratio * 30
  swap_bonus = 10 if swapped else 0
  confidence = min(base + address_bonus + swap_bonus, 95)
  ```

**File: `run_optimized_analysis.py`**
- Integration script, doesn't need changes

**Documents:**
- `docs/bmm-brainstorming-session-2025-11-14.md` - Business requirements
- `docs/analysis-of-bmm-brainstorming-session-2025-11-14.md` - Technical stack

### 4. Problem Analysis

**What Was Lost:**

1. **Two-Stage Process:** Now only does fuzzy matching in one pass
2. **Exact Match Priority:** Exact normalized matches should be detected first with high confidence
3. **Confidence Scoring:** All matches use same formula `(name*0.7 + addr*0.3)*100`, no differentiation between exact and fuzzy
4. **Match Type Granularity:** Should distinguish exact_normal, exact_swapped, fuzzy_normal, fuzzy_swapped

**What's Working:**
- ✅ Date rules (Geburtstag/Jahrgang) - correctly implemented
- ✅ Zweitname rule - correctly implemented  
- ✅ PLZ blocking - excellent performance
- ✅ Parallel processing - scales well
- ✅ German name normalization - handles umlauts correctly

### 5. Implementation Plan

**Step 1: Refactor `process_block_worker` for Two Stages**
- Add Stage 1: Check for exact normalized name matches (both normal and swapped)
- Track matched indices to skip in Stage 2
- Add Stage 2: Fuzzy match remaining unmatched records
- Keep business rules checks in both stages

**Step 2: Implement Proper Exact Match Detection**
```python
# Pseudo-code for exact match
def check_exact_match(record_a, record_b):
    # Business rules first
    if not check_zweitname_rule(...): return None
    if not check_date_rule(...): return None
    
    # Normalize names
    v_a_norm = normalize(vorname_a)
    n_a_norm = normalize(name_a)
    v_b_norm = normalize(vorname_b)
    n_b_norm = normalize(name_b)
    
    # Check both orders
    normal_match = (v_a_norm == v_b_norm and n_a_norm == n_b_norm)
    swapped_match = (v_a_norm == n_b_norm and n_a_norm == v_b_norm)
    
    if normal_match or swapped_match:
        # Calculate confidence based on address fields
        # Return MatchResult with 90-100% confidence
```

**Step 3: Fix Confidence Scoring**
- Exact matches: 90-100% based on address field matches
- Fuzzy normal: 70-90% based on similarity scores
- Fuzzy swapped: 65-85% (slightly lower, name swap is suspicious)
- Formula for exact: `90 + (address_match_ratio * 10)`
- Formula for fuzzy: Keep current but cap appropriately

**Step 4: Update Match Type Tracking**
- Change from 3 types (exact, fuzzy_normal, fuzzy_swapped)
- To 4 types: exact_normal, exact_swapped, fuzzy_normal, fuzzy_swapped
- This helps fraud investigators understand the match pattern

**Step 5: Test with Sample Data**
- Use existing test cases from POC
- Verify all business rules work correctly
- Ensure performance is maintained

### 6. Success Criteria
- ✅ Two-stage architecture restored
- ✅ Exact matches get 90-100% confidence
- ✅ Fuzzy matches get 60-90% confidence (capped at 95%)
- ✅ All 4 match types properly distinguished
- ✅ Business rules (date, Zweitname) still working
- ✅ Performance maintained (blocking, parallel processing)
- ✅ Test cases pass from POC